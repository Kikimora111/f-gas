<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>F-gas å†å²æ’æ”¾æ•°æ®å¯è§†åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        
        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        select {
            padding: 8px 12px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            min-width: 200px;
        }
        
        #chart-container { width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 4px; }
        .footer { text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; }
    </style>
</head>
<body>

    <h1> F-gas å¤šæºæ’æ”¾æ•°æ®å¯¹æ¯”</h1>

    <div class="controls">
        <label for="substance-select"><strong>é€‰æ‹©è¦åˆ†æçš„ç‰©è´¨ï¼š</strong></label>
        <select id="substance-select">
            <option value="">æ­£åœ¨åŠ è½½æ•°æ®...</option>
        </select>
    </div>

    <div id="chart-container"></div>

    <div class="footer">
        æ•°æ®æ¥æºï¼šå¤šæºå¯¹æ¯”åˆ†æ | <a href="data.csv" download>ğŸ“¥ ä¸‹è½½æºæ•°æ®</a>
    </div>

    <script>
        var myChart = echarts.init(document.getElementById('chart-container'));
        var globalData = []; // å­˜å‚¨è¯»å–åˆ°çš„å®Œæ•´æ•°æ®
        var distinctYears = []; // å­˜å‚¨æ‰€æœ‰å¹´ä»½

        myChart.showLoading();

        Papa.parse("data.csv?v=2", {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                myChart.hideLoading();
                
                // 1. æ•°æ®é¢„å¤„ç†
                var rawData = results.data;
                var columns = results.meta.fields;

                // ç®€å•çš„é”™è¯¯æ£€æŸ¥
                if (!columns.includes("Source") || !columns.includes("Year")) {
                    alert("CSVæ ¼å¼é”™è¯¯ï¼å¿…é¡»åŒ…å« 'Year' å’Œ 'Source' åˆ—ï¼ˆæ³¨æ„é¦–å­—æ¯å¤§å†™ï¼‰ã€‚");
                    return;
                }

                // 2. æå–æ‰€æœ‰ç‰©è´¨åç§° (æ’é™¤ Year å’Œ Source)
                var substances = columns.filter(col => col !== "Year" && col !== "Source");

                // 3. æå–æ‰€æœ‰å¹´ä»½ (å»é‡å¹¶æ’åº)
                var yearsSet = new Set(rawData.map(row => row.Year));
                distinctYears = Array.from(yearsSet).sort((a, b) => a - b);

                // 4. å¡«å……ä¸‹æ‹‰èœå•
                var selectEl = document.getElementById('substance-select');
                selectEl.innerHTML = ""; // æ¸…ç©ºåŠ è½½æç¤º
                
                substances.forEach((sub, index) => {
                    var option = document.createElement("option");
                    option.value = sub;
                    option.text = sub;
                    selectEl.appendChild(option);
                });

                // 5. å­˜å‚¨æ•°æ®å¹¶åˆå§‹åŒ–å›¾è¡¨
                globalData = rawData;
                
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç‰©è´¨å¹¶ç”»å›¾
                updateChart(substances[0]);

                // ç›‘å¬ä¸‹æ‹‰èœå•å˜åŒ–
                selectEl.addEventListener('change', function(e) {
                    updateChart(e.target.value);
                });
            },
            error: function(err) {
                alert("æ— æ³•è¯»å– data.csvï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸Šä¼ ã€‚");
            }
        });

        // æ ¸å¿ƒå‡½æ•°ï¼šæ ¹æ®é€‰ä¸­çš„ç‰©è´¨æ›´æ–°å›¾è¡¨
        function updateChart(selectedSubstance) {
            // 1. æ‰¾å‡ºæ•°æ®é‡Œæ‰€æœ‰çš„æ¥æº (Source)ï¼Œæ¯”å¦‚ EDGAR, EPA
            // Set è‡ªåŠ¨å»é‡
            var sources = Array.from(new Set(globalData.map(row => row.Source)));

            // 2. ä¸ºæ¯ä¸ª Source æ„å»ºä¸€æ¡çº¿
            var seriesData = sources.map(sourceName => {
                
                // æ‰¾åˆ°è¯¥ Source å¯¹åº”çš„æ‰€æœ‰è¡Œ
                var sourceRows = globalData.filter(row => row.Source === sourceName);
                
                // æŠŠæ•°æ®æ˜ å°„åˆ°å¹´ä»½è½´ä¸Š (é˜²æ­¢æŸä¸€å¹´ç¼ºå¤±å¯¼è‡´é”™ä½)
                var dataPoints = distinctYears.map(year => {
                    // æ‰¾è¿™ä¸€å¹´ã€è¿™ä¸ªSourceå¯¹åº”çš„é‚£ä¸€è¡Œ
                    var row = sourceRows.find(r => r.Year === year);
                    // å¦‚æœæ‰¾åˆ°äº†ï¼Œè¿”å›å¯¹åº”çš„ç‰©è´¨æ•°å€¼ï¼›å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å› null (å›¾è¡¨ä¼šæ–­å¼€)
                    return row ? row[selectedSubstance] : null;
                });

                return {
                    name: sourceName, // çº¿æ¡åå­—ç°åœ¨æ˜¯â€œæ¥æºâ€
                    type: 'line',
                    smooth: true,
                    data: dataPoints,
                    symbolSize: 8
                };
            });

            // 3. è®¾ç½®å›¾è¡¨é…ç½®
            var option = {
                title: {
                    text: selectedSubstance + ' æ’æ”¾é‡å¯¹æ¯”',
                    left: 'center',
                    top: 10
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: sources, // å›¾ä¾‹æ˜¾ç¤ºçš„æ˜¯æ¥æº
                    bottom: 0,
                    padding: 20
                },
                grid: {
                    left: '3%', right: '4%', bottom: '15%', containLabel: true
                },
                xAxis: {
                    type: 'category',
                    name: 'å¹´ä»½',
                    data: distinctYears
                },
                yAxis: {
                    type: 'value',
                    name: 'æ’æ”¾é‡ (å¨/CO2e)'
                },
                series: seriesData,
                // é¢œè‰²ç›˜ï¼šå¦‚æœçº¿æ¡å¤šï¼Œè‡ªåŠ¨å¾ªç¯è¿™äº›é¢œè‰²
                color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272']
            };

            myChart.setOption(option, true); // true è¡¨ç¤ºä¸åˆå¹¶æ—§æ•°æ®ï¼Œå®Œå…¨é‡ç»˜
        }

        window.addEventListener('resize', () => myChart.resize());
    </script>
</body>
</html>
